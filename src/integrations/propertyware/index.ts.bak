/**
 * PropertyWare Integration Wrapper for PMIP
 * Uses the external @rashidazarang/propertyware-adapter npm package
 */

import { PropertyWareAdapter } from '@rashidazarang/propertyware-adapter';
import { PropertyWareConfig } from '../../types/index.js';
import { logger } from '../../utils/logger.js';
import { EventEmitter } from 'events';

export class PropertyWareIntegration extends EventEmitter {
  private adapter: PropertyWareAdapter;
  private config: PropertyWareConfig;
  private isInitialized: boolean = false;
  private isDryRun: boolean = false;
  private mockData: Map<string, any> = new Map();
  
  constructor(config: PropertyWareConfig) {
    super();
    this.config = config;
    
    // Initialize the external adapter
    this.adapter = new PropertyWareAdapter({
      wsdl: config.wsdl,
      url: config.url,
      username: config.username,
      password: config.password,
      options: {
        rateLimit: config.rateLimit || 2,
        retryAttempts: config.retryAttempts || 3,
        timeout: config.timeout || 30000,
        batchSize: config.batchSize || 100
      }
    });
    
    // Forward adapter events
    this.setupEventForwarding();
  }
  
  /**
   * Initialize PropertyWare adapter
   */
  async initialize(options?: { dryRun?: boolean }): Promise<void> {
    this.isDryRun = options?.dryRun || false;
    
    if (this.isDryRun) {
      logger.info('PropertyWare integration initialized in DRY-RUN mode');
      this.isInitialized = true;
      this.setupMockData();
      return;
    }
    
    try {
      await this.adapter.connect();
      this.isInitialized = true;
      logger.info('PropertyWare integration initialized using external adapter');
    } catch (error) {
      logger.error('Failed to initialize PropertyWare integration', error);
      throw error;
    }
  }
  
  /**
   * Enable or disable dry-run mode
   */
  setDryRun(enabled: boolean): void {
    this.isDryRun = enabled;
    if (enabled) {
      logger.info('PropertyWare integration: DRY-RUN mode enabled');
      this.setupMockData();
    } else {
      logger.info('PropertyWare integration: DRY-RUN mode disabled');
    }
  }
  
  /**
   * Setup mock data for dry-run mode
   */
  private setupMockData(): void {
    // Mock portfolios
    this.mockData.set('portfolios', [
      {
        portfolioId: 'MOCK-PF-001',
        name: 'Mock Portfolio Alpha',
        active: true,
        ownerFirstName: 'John',
        ownerLastName: 'Doe',
        ownerEmail: 'john.doe@mockproperty.com',
        ownerPhone: '555-0100',
        createdAt: new Date('2024-01-01'),
        updatedAt: new Date()
      },
      {
        portfolioId: 'MOCK-PF-002',
        name: 'Mock Portfolio Beta',
        active: true,
        ownerFirstName: 'Jane',
        ownerLastName: 'Smith',
        ownerEmail: 'jane.smith@mockproperty.com',
        ownerPhone: '555-0101',
        createdAt: new Date('2024-02-01'),
        updatedAt: new Date()
      }
    ]);
    
    // Mock buildings
    this.mockData.set('buildings', [
      {
        buildingId: 'MOCK-BLD-001',
        buildingKey: 'BLD001',
        portfolioKey: 'PF001',
        buildingName: 'Mock Building One',
        address: '123 Mock Street',
        city: 'Mock City',
        state: 'TX',
        zip: '78701',
        unitCount: 10,
        createdAt: new Date('2024-01-15'),
        updatedAt: new Date()
      },
      {
        buildingId: 'MOCK-BLD-002',
        buildingKey: 'BLD002',
        portfolioKey: 'PF002',
        buildingName: 'Mock Building Two',
        address: '456 Test Avenue',
        city: 'Test Town',
        state: 'CA',
        zip: '90210',
        unitCount: 20,
        createdAt: new Date('2024-02-15'),
        updatedAt: new Date()
      }
    ]);
    
    // Mock work orders
    this.mockData.set('workOrders', [
      {
        workOrderId: 'MOCK-WO-001',
        buildingId: 'MOCK-BLD-001',
        portfolioId: 'MOCK-PF-001',
        description: 'Fix leaking faucet in unit 5',
        status: 'Open',
        priority: 'Normal',
        category: 'Plumbing',
        createdAt: new Date('2024-09-01'),
        updatedAt: new Date()
      },
      {
        workOrderId: 'MOCK-WO-002',
        buildingId: 'MOCK-BLD-002',
        portfolioId: 'MOCK-PF-002',
        description: 'HVAC maintenance required',
        status: 'In Progress',
        priority: 'High',
        category: 'HVAC',
        assignedVendor: 'Mock HVAC Services',
        createdAt: new Date('2024-09-05'),
        updatedAt: new Date()
      }
    ]);
  }
  
  /**
   * Setup event forwarding from adapter to PMIP
   */
  private setupEventForwarding(): void {
    // Forward connection events
    this.adapter.on('connected', () => {
      this.emit('connected');
      logger.debug('PropertyWare adapter connected');
    });
    
    this.adapter.on('disconnected', () => {
      this.emit('disconnected');
      logger.debug('PropertyWare adapter disconnected');
    });
    
    this.adapter.on('error', (error) => {
      this.emit('error', error);
      logger.error('PropertyWare adapter error', error);
    });
    
    // Forward sync events
    this.adapter.on('sync:started', (data) => {
      this.emit('sync:started', data);
    });
    
    this.adapter.on('sync:progress', (data) => {
      this.emit('sync:progress', data);
    });
    
    this.adapter.on('sync:completed', (data) => {
      this.emit('sync:completed', data);
    });
    
    this.adapter.on('sync:error', (data) => {
      this.emit('sync:error', data);
    });
  }
  
  /**
   * Get portfolios from PropertyWare
   */
  async getPortfolios(options?: any): Promise<any[]> {
    if (this.isDryRun) {
      logger.info('[DRY-RUN] Returning mock portfolios');
      return this.mockData.get('portfolios') || [];
    }
    return this.adapter.getPortfolios(options);
  }
  
  /**
   * Get buildings from PropertyWare
   */
  async getBuildings(portfolioId?: string): Promise<any[]> {
    if (this.isDryRun) {
      logger.info('[DRY-RUN] Returning mock buildings');
      const buildings = this.mockData.get('buildings') || [];
      return portfolioId 
        ? buildings.filter(b => b.portfolioKey === portfolioId)
        : buildings;
    }
    return this.adapter.getBuildings(portfolioId);
  }
  
  /**
   * Get units from PropertyWare
   */
  async getUnits(buildingId?: string): Promise<any[]> {
    return this.adapter.getUnits(buildingId);
  }
  
  /**
   * Get leases from PropertyWare
   */
  async getLeases(options?: any): Promise<any[]> {
    return this.adapter.getLeases(options);
  }
  
  /**
   * Get work orders from PropertyWare
   */
  async getWorkOrders(options?: any): Promise<any[]> {
    if (this.isDryRun) {
      logger.info('[DRY-RUN] Returning mock work orders');
      return this.mockData.get('workOrders') || [];
    }
    return this.adapter.getWorkOrders(options);
  }
  
  /**
   * Create work order in PropertyWare
   */
  async createWorkOrder(data: any): Promise<any> {
    if (this.isDryRun) {
      logger.info('[DRY-RUN] Would create work order:', data);
      return {
        ...data,
        workOrderId: `MOCK-WO-${Date.now()}`,
        status: 'Open',
        createdAt: new Date()
      };
    }
    return this.adapter.createWorkOrder(data);
  }
  
  /**
   * Update work order in PropertyWare
   */
  async updateWorkOrder(id: string, data: any): Promise<any> {
    if (this.isDryRun) {
      logger.info(`[DRY-RUN] Would update work order ${id}:`, data);
      return {
        workOrderId: id,
        ...data,
        updatedAt: new Date()
      };
    }
    return this.adapter.updateWorkOrder(id, data);
  }
  
  /**
   * Get vendors from PropertyWare
   */
  async getVendors(options?: any): Promise<any[]> {
    return this.adapter.getVendors(options);
  }
  
  /**
   * Get contacts from PropertyWare
   */
  async getContacts(options?: any): Promise<any[]> {
    return this.adapter.getContacts(options);
  }
  
  /**
   * Get owners from PropertyWare
   */
  async getOwners(options?: any): Promise<any[]> {
    return this.adapter.getOwners(options);
  }
  
  /**
   * Get prospects from PropertyWare
   */
  async getProspects(options?: any): Promise<any[]> {
    return this.adapter.getProspects(options);
  }
  
  /**
   * Batch sync entities from PropertyWare
   */
  async batchSync(entityType: string, options?: any): Promise<any> {
    return this.adapter.batchSync(entityType, options);
  }
  
  /**
   * Get all entities (paginated automatically)
   */
  async getAllEntities(entityType: string, options?: any): Promise<any[]> {
    return this.adapter.getAllEntities(entityType, options);
  }
  
  /**
   * Search entities with filters
   */
  async searchEntities(entityType: string, filters: any): Promise<any[]> {
    return this.adapter.searchEntities(entityType, filters);
  }
  
  /**
   * Get adapter status
   */
  getStatus(): any {
    return {
      isConnected: this.adapter.isConnected(),
      isInitialized: this.isInitialized,
      rateLimitStatus: this.adapter.getRateLimitStatus()
    };
  }
  
  /**
   * Disconnect from PropertyWare
   */
  async disconnect(): Promise<void> {
    await this.adapter.disconnect();
    this.isInitialized = false;
    logger.info('PropertyWare integration disconnected');
  }
  
  /**
   * Get the underlying adapter instance (for advanced usage)
   */
  getAdapter(): PropertyWareAdapter {
    return this.adapter;
  }
}